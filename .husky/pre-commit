# npm test

#!/bin/sh
###############################################################################
# Husky Pre-commit Hook
#
# Purpose:
# - Prevent insecure dependencies (Composer Audit)
# - Prevent broken tests (Pest)
# - Enforce coding standards (Laravel Pint)
# - Enforce static analysis (PHPStan)
#
# Notes:
# - This script only runs on staged PHP files to optimize performance.
# - If Pint auto-fixes files, you must re-stage them before committing.
###############################################################################

echo "ğŸ”’ [1/4] Security Check â€“ Composer Audit"
composer audit --no-interaction
if [ $? -ne 0 ]; then
  echo "âŒ Security vulnerabilities detected!"
  exit 1
fi

# echo "ğŸ§ª [2/4] Run Tests â€“ Pest"
# ./vendor/bin/pest
# if [ $? -ne 0 ]; then
#   echo "âŒ Some tests failed!"
#   exit 1
# fi

# Prepare PHP file list
TEMP_DIR="./storage/phpstan"
mkdir -p "$TEMP_DIR"

STAGED_FILES_TEMP="$TEMP_DIR/staged_files_$(date +%s).txt"
PHPSTAN_OUTPUT_TEMP="$TEMP_DIR/phpstan_output_$(date +%s).txt"

cleanup() {
  rm -f "$STAGED_FILES_TEMP" "$PHPSTAN_OUTPUT_TEMP"
}
trap cleanup EXIT INT TERM

git diff --cached --name-only --diff-filter=ACMR | grep "\.php$" > "$STAGED_FILES_TEMP"

if [ ! -s "$STAGED_FILES_TEMP" ]; then
  echo "â„¹ No staged PHP files. Skipping Pint & PHPStan."
  exit 0
fi

echo "ğŸ¨ [3/4] Code Style â€“ Laravel Pint"
./vendor/bin/pint $(cat "$STAGED_FILES_TEMP")
git add $(cat "$STAGED_FILES_TEMP")

echo "ğŸ” [4/4] Static Analysis â€“ Larastan (PHPStan)"
if ! ./vendor/bin/phpstan analyse --memory-limit=2G; then
  echo "âŒ Commit aborted: Larastan found issues."
  exit 1
fi

echo "âœ… All checks passed. Proceeding with commit."